<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Customer Dashboard</title>
  <script src="/socket.io/socket.io.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { padding: 10px; border: 1px solid #ccc; text-align: left; }
    button { margin-right: 5px; padding: 6px 12px; }
  </style>
</head>
<body>

  <h1>Customer Dashboard</h1>
  <p id="status">Connecting...</p>

  <table id="appointmentsTable">
    <thead>
      <tr>
        <th>Stylist Username</th>
        <th>Hairstyle</th>
        <th>Date</th>
        <th>Time</th>
        <th>Status</th>
      </tr>
    </thead>
    <tbody id="appointmentsBody"></tbody>
  </table> <br>

  <div id="UpdateInfo">
      <input type="button" value="Update My Profile">
  </div>

  <form id="customerData" style="display:none;">
    <label for="firstNameInput">First Name</label><br>
    <input type="text" id="firstNameInput" name="firstNameInput"> <br>

    <label for="lastNameInput">Last Name</label><br>
    <input type="text" id="lastNameInput" name="lastNameInput"> <br>

    <label for="phoneNumberInput">Phone Number</label><br>
    <input type="text" id="phoneNumberInput" name="phoneNumberInput"> <br>

    <label for="emailInput">Email</label><br>
    <input type="text" id="emailInput" name="emailInput"> <br>

    <button type='submit'>Submit Update</button>
  </form>
  <script>
      let socket; //making socket global
      async function customerDash(){
          try{
              //get customerUsername
              const response = await fetch("http://localhost:3100/auth/customer/me",{
              method : 'GET',
              credentials : 'include'
            })

            if(!response.ok) throw new Error("Unauthorized");
            const data = await response.json()
            console.log('custoer data db-dash: ', data)
            const customerUsername = data.username;
            document.getElementById("status").textContent = "Connected as " + customerUsername;
          
            //get customerappontment
            const customerAp = await fetch("http://localhost:3100/auth/customer/appointment",
                {
                  method : "GET",
                  credentials : "include"
                })
        
            const customerAppointment = await customerAp.json()
            //Ensure frontend handles non array with Array.isArray as forEach expects an array 
            const appoinments = Array.isArray(customerAppointment) ? customerAppointment : [];
            appoinments.forEach(addAppointmentRow);
          
            //conncetion socket
            socket = io("http://localhost:3100", {
              reconnection: false
            });
      
            socket.on('connect', ()=>{
            console.log("Socket connected:", socket.id);
            
            // customer joins room
            socket.emit("joinCustomerRoom", customerUsername);
            console.log("Joining customer room:", customerUsername);
            
            })      
            //customer books new appointment
            socket.on("newCustomerAppointment", (appointment) => {
              console.log("New appointmnet successfully booked: ", appointment)
              addAppointmentRow(appointment);
            });
            // Customer receives stylist response
            socket.on('appointmentStatusUpdated', ({ appointmentId, status }) => {
              `${status}`=== 'approved' 
              ? alert(`Your appointment is ${status}`)
              : alert(`Stylist currently unavailable. Please reschedule.`)
              
              console.log("Received appointment update", { appointmentId, status });
              
              const row = document.querySelector(`tr[data-id='${appointmentId}']`);
              if (row) {
              // Find the status cell, its position (5th), and update its text
              const statusCell = row.cells[4]; // zero-based index (4)
                if (statusCell) {
                  statusCell.textContent = status;
                }
              } else {
                console.warn(`No row found for appointmentId ${appointmentId}`);
              }
            });  
          }catch(error){
            console.log('Error getting customer name from db')
            alert(`${error.message}`)
          }
      }
      customerDash()
      function addAppointmentRow(appointment) {
          if (!appointment || !appointment.appointmentId) {
              console.error("Invalid appointment data received:", appointment);
              return;
          }
          console.log("Received appointment:", appointment);
          const tbody = document.getElementById("appointmentsBody");
          const row = document.createElement("tr");
          row.setAttribute("data-id", appointment.appointmentId);
          // Ensure values are safely escaped and strings
          const apptId = String(appointment.appointmentId);
          const custUser = String(appointment.customerUsername); 
          row.innerHTML = `
            <td>${appointment.stylistUsername}</td>
            <td>${appointment.hairStyle}</td>
            <td>${appointment.date}</td>
            <td>${appointment.time}</td>
            <td>${appointment.status}</td> 
            `;
            tbody.appendChild(row);
        }
        //update btn
        const updateBtn = document.getElementById('UpdateInfo')
        updateBtn.addEventListener('click', async ()=>{
          updateBtn.style.display = 'none';
          const customerDataForm = document.getElementById('customerData')
          customerDataForm.style.display = 'block';

          try{
            const response = await fetch('http://localhost:3100/auth/customer/profile', {
              method : 'GET',
              credentials : 'include'
            })
            const data = await response.json()
            const profile = Array.isArray(data) && data.length > 0 ? data[0] : [] 
            document.getElementById('firstNameInput').value = `${profile.first_name}`
            document.getElementById('lastNameInput').value = `${profile.last_name}`
            document.getElementById('phoneNumberInput').value = `${profile.phone_number}`
            document.getElementById('emailInput').value = `${profile.email}`

          }catch(err){
            consolr.log('Error loading customer profile: ', err.message)
            alert(err.message)
          }

        })

        //submit profile update
        document.getElementById('customerData').addEventListener('submit', async (e)=>{
          try{
            e.preventDefault();
            const updateFirstName = document.getElementById('firstNameInput').value
            const updateLastName = document.getElementById('lastNameInput').value;
            const updateEmail = document.getElementById('emailInput').value;
            const updatePhoneNumber = document.getElementById('phoneNumberInput').value
            
            const body = 
            {
              updateFirstName, updateLastName, updateEmail, updatePhoneNumber, 
            }
            const response = await fetch('http://localhost:3100/auth/customer/profile/update', {
              method : "PATCH",
              body : JSON.stringify(body),
              credentials : 'include',
              headers : {
                "Content-Type" : 'application/json'
              }
            })
            const data = await response.json()
            if (response.ok){
              console.log(data.message)
              alert(`Congrats! ${data.message}`)
            }else{
              alert(`${data.message}`)
            }
          
          }catch(err){
            console.log('Error updating customer info: ', err.message)
            alert("Failed to update customer info " + err.message)
          }
          
        })

  </script>

</body>
</html>
